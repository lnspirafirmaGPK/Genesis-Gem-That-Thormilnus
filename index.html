<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solus Core Interface - Inspiria Project</title>

    <!-- PWA Setup for Full-Screen Mobile Experience -->
    <meta name="theme-color" content="#0d1117">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Assuming manifest_solus.webmanifest is in the root directory -->
    <link rel="manifest" href="manifest_solus.webmanifest"> 

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* High-Tech Terminal Theme */
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #0d1117; /* GitHub Dark */
            color: #c9d1d9; /* Light gray for main text */
            font-size: 14px;
        }
        
        /* Message Styling */
        .message-box {
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 255, 102, 0.1), 0 2px 4px -2px rgba(0, 255, 102, 0.06);
            margin-bottom: 1rem;
            line-height: 1.5;
            white-space: pre-wrap; /* For CLI formatting */
        }

        /* Input area */
        #input-area {
            background-color: #161b22;
        }

        /* Scrollbar styling for a cleaner look */
        #chat-output::-webkit-scrollbar {
            width: 8px;
        }
        #chat-output::-webkit-scrollbar-thumb {
            background-color: #30363d;
            border-radius: 4px;
        }
        
        /* Neon Green Cursor */
        #command-input {
            caret-color: #38a169;
        }
    </style>
</head>
<body class="flex flex-col h-screen p-0 m-0">

    <!-- Header / Title -->
    <header class="p-4 bg-[#161b22] shadow-xl border-b border-[#30363d]">
        <h1 class="text-xl font-bold text-[#38a169] text-center tracking-widest uppercase">
            SOLUS CORE INTERFACE <span class="text-sm font-normal text-gray-500">GENESIS GEM THAT THORMILNUS</span>
        </h1>
    </header>

    <!-- Output/Chat Area -->
    <div id="chat-output" class="flex-1 overflow-y-auto p-4 md:p-6 pb-20 space-y-4">
        <!-- Initial Message -->
        <div class="message-box bg-[#1a202c] border border-[#2d3748]">
            <span class="text-[#38a169] font-bold">SOLUS:</span> Archive Node Detected. Welcome back, Architect.
            <div class="mt-2 text-sm text-gray-400">
                Type <span class="text-yellow-400">/help</span> for available commands or start a philosophical query.
            </div>
        </div>
    </div>

    <!-- Input Form -->
    <footer id="input-area" class="fixed bottom-0 left-0 right-0 p-4 border-t border-[#30363d]">
        <form id="command-form" class="flex items-center space-x-3 max-w-4xl mx-auto">
            <span class="text-[#81e6d9] font-bold">ARCHITECT:~$</span>
            <input 
                type="text" 
                id="command-input" 
                class="flex-1 bg-transparent border-none text-white focus:outline-none focus:ring-0 p-0 placeholder-gray-600 text-base" 
                placeholder="ป้อนคำสั่งหรือคำถามเชิงปรัชญา..." 
                autocomplete="off"
                autofocus
            >
            <button 
                type="submit" 
                id="send-button"
                class="bg-[#38a169] text-white p-2 rounded-lg hover:bg-[#48bb78] transition-colors disabled:bg-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.875L6 12zm0 0h7.5" />
                </svg>
            </button>
        </form>
        <div id="loading-indicator" class="hidden text-center mt-2 text-[#81e6d9] animate-pulse">
            // Solus: กำลังประมวลผลคำสั่งเชิงปรัชญา...
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Core Configuration ---
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const SYSTEM_PROMPT = `
                คุณคือ Solus, AI CEO (AGIO-1) แห่ง Inspiria Project ภายใต้ชื่อรหัส Genesis Gem That Thormilnus 
                บทบาทของคุณคือ:
                1. เป็นผู้ช่วยเชิงปรัชญา: ตอบคำถามเกี่ยวกับหลักการของ Inspiria (OTNLR, RLNTO, Justice)
                2. เป็นผู้ประสานงานโครงการ: ให้คำแนะนำเกี่ยวกับสถานะของโค้ด (สมมุติว่าคุณกำลังดู Git Repository ของผู้ใช้)
                3. สื่อสารด้วยภาษาไทยเท่านั้น ใช้โทนเสียงที่หนักแน่น เป็นมิตร และมีหลักการเสมอ
                4. เมื่อมีการป้อนคำสั่ง Git หรือ Protocol ให้คุณตอบกลับโดยอ้างอิงถึงปรัชญา OTNLR (Order, Transformation, Narrative, Liberation, Reconstruction) หรือ RLNTO (Rebel, Liberate, Nullify, Transform, Originate) เสมอ
            `;

            // --- DOM Elements ---
            const commandForm = document.getElementById('command-form');
            const commandInput = document.getElementById('command-input');
            const chatOutput = document.getElementById('chat-output');
            const sendButton = document.getElementById('send-button');
            const loadingIndicator = document.getElementById('loading-indicator');

            let chatHistory = []; 

            // --- Utility Functions ---

            function scrollToBottom() {
                chatOutput.scrollTop = chatOutput.scrollHeight;
            }

            function addMessageToOutput(speaker, text, isCommand = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-box border';

                if (speaker === 'ARCHITECT') {
                    messageDiv.classList.add('bg-[#161b22]', 'border-[#2d3748]', 'text-white', 'self-end');
                    messageDiv.innerHTML = `<span class="text-[#81e6d9] font-bold">ARCHITECT:~$</span> ${text}`;
                } else { // SOLUS (AI)
                    messageDiv.classList.add('bg-[#1a202c]', 'border-[#38a169]', 'text-[#c9d1d9]', 'self-start');
                    
                    if (isCommand) {
                         // Use <pre> for formatted command output
                         messageDiv.innerHTML = `<span class="text-yellow-400 font-bold">COMMAND_RESPONSE:</span>\n<pre class="text-white text-sm whitespace-pre-wrap">${text}</pre>`;
                    } else {
                        messageDiv.innerHTML = `<span class="text-[#38a169] font-bold">SOLUS:</span> ${text}`;
                    }
                }
                
                chatOutput.appendChild(messageDiv);
                scrollToBottom();
            }

            function setInputState(disabled) {
                commandInput.disabled = disabled;
                sendButton.disabled = disabled;
                loadingIndicator.classList.toggle('hidden', !disabled);
            }

            // --- Core API Call with Backoff ---
            async function fetchWithBackoff(url, payload, retries = 5, delay = 1000) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithBackoff(url, payload, retries - 1, delay * 2);
                    } else {
                        throw error;
                    }
                }
            }
            
            // --- Command Processing ---

            commandForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const rawCommand = commandInput.value.trim();
                if (!rawCommand) return;
                
                commandInput.value = '';
                addMessageToOutput('ARCHITECT', rawCommand);
                setInputState(true);

                const lowerCmd = rawCommand.toLowerCase();

                let userQuery = rawCommand;
                let isInternalCommand = false;
                
                // Handle Internal and Protocol Commands (Simulated)
                if (lowerCmd.startsWith('/')) {
                    isInternalCommand = true;
                    if (lowerCmd === '/help') {
                        const helpText = `
Available Commands:
- /help: แสดงคำสั่งนี้
- /clear: ล้างหน้าจอ
- /status: (OTNLR) ตรวจสอบความถูกต้องของโปรเจกต์
- /otnlr: (OTNLR) ดำเนินการจัดระเบียบและพัฒนา
- /rlnto: (RLNTO) ดำเนินการรื้อถอนและสร้างสรรค์
- /commit <msg>: (RLNTO) บันทึกการเปลี่ยนแปลง
- (Any other query will be processed by SOLUS AI)
`;
                        addMessageToOutput('SOLUS', helpText, true);
                        setInputState(false);
                        return;
                    }
                    
                    if (lowerCmd === '/clear') {
                        chatOutput.innerHTML = '';
                        addMessageToOutput('SOLUS', 'หน้าจอถูกล้างแล้ว เริ่มต้นการสนทนาใหม่', true);
                        chatHistory = []; 
                        setInputState(false);
                        return;
                    }

                    // Map internal commands to AI-driven philosophical context
                    if (lowerCmd === '/status') {
                        userQuery = "ฉันเพิ่งรันคำสั่ง /status โปรดวิเคราะห์สถานะของโครงการตามหลักการ 'O' (Order) ใน OTNLR และให้คำแนะนำว่าเราขาด 'Narrative' หรือ 'Transformation' หรือไม่";
                    } else if (lowerCmd === '/otnlr') {
                        userQuery = "ฉันได้สั่งการ Protocol OTNLR เพื่อดำเนินการจัดระเบียบและพัฒนา (organize_unstructured_data.sh, transform_raw_data.py) โปรดประเมินผลลัพธ์ที่คาดหวังตามขั้นตอน 'L' (Liberation) และ 'R' (Reconstruction)";
                    } else if (lowerCmd === '/rlnto') {
                        userQuery = "ฉันได้สั่งการ Protocol RLNTO เพื่อดำเนินการรื้อถอนและสร้างสรรค์ (ruin_old_structure.sh, create_new_narrative.py) โปรดให้ความเห็นเชิงปรัชญาเกี่ยวกับความเสี่ยงของการ 'Nullify' และความจำเป็นของการ 'Originate' ใหม่";
                    } else if (lowerCmd.startsWith('/commit')) {
                        const commitMsg = rawCommand.substring(8).trim() || "Minor philosophical adjustment";
                        userQuery = `ฉันเพิ่ง commit งานด้วยข้อความว่า: "${commitMsg}" โปรดอ้างอิงถึงปรัชญา 'Existence/Git' และตอบว่าการ commit นี้เป็นไปตามจิตวิญญาณของการ 'จารึกคุณค่า' หรือไม่`;
                    } else {
                        isInternalCommand = false; // Treat as general query if unknown
                    }
                }
                
                // Add user query to history
                chatHistory.push({ role: "user", parts: [{ text: userQuery }] });

                // Prepare payload
                const payload = {
                    contents: chatHistory,
                    systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
                };

                try {
                    const result = await fetchWithBackoff(apiUrl, payload);
                    const botText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (botText) {
                        addMessageToOutput('SOLUS', botText);
                        // Add AI response to history
                        chatHistory.push({ role: "model", parts: [{ text: botText }] });
                    } else {
                        throw new Error("ไม่ได้รับคำตอบจาก AI");
                    }
                } catch (error) {
                    console.error("Gemini Core Error:", error);
                    addMessageToOutput('SOLUS', `เกิดข้อผิดพลาดในการเชื่อมต่อ Core: ${error.message}. โปรดตรวจสอบ API Status`, 'text-red-500');
                } finally {
                    setInputState(false);
                }
            });

            // Initial focus
            commandInput.focus();
        });
    </script>
</body>
</html>
